---
- hosts: app
  remote_user: root
  tasks:
  - locale_gen: name=en_US.UTF-8 state=present
  - name: Install required system packages.
    apt: pkg={{ item }} state=installed
    tags: packages
    with_items:
      - git
      - nodejs
      - curl
      - npm
      - postgresql
      - libpq-dev
      - python-psycopg2

  - name: Node alias to nodejs
    shell: ln -s /usr/bin/nodejs /usr/bin/node

  - name: Install forever js
    npm: 
      name: forever
      global: yes

  - name: Postgres | Start Postgres
    service: name=postgresql state=started

  - name: Postgres | Create db user
    postgresql_user:
      name: "{{dbuser}}"
      password: "{{dbuser}}"
      role_attr_flags: SUPERUSER
      login_user: "postgres"
    sudo_user: "postgres"
    sudo: yes

  - name: Postgres | Create db
    postgresql_db:
      name: "{{dbuser}}"
    sudo_user: "postgres"
    sudo: yes

  - name: Install KIRIES [add syslog-ng key]
    apt_key:
      url: http://download.opensuse.org/repositories/home:/laszlo_budai:/syslog-ng/Debian_8.0/Release.key

  - name: Install KIRIES [add source list]
    apt_repository:
      repo: deb http://download.opensuse.org/repositories/home:/laszlo_budai:/syslog-ng/Debian_8.0 ./ 

  - name: Install KIRIES [install syslog-ng]
    apt:
      name: {{ item }}
      update_cache: true
    with_items:
      - syslog-ng-core
      - syslog-ng-mod-riemann

  - name: Install KIRIES [install clojure]
    get_url: url=https://raw.githubusercontent.com/technomancy/leiningen/2.5.1/bin/lein
             dest=/usr/bin/lein
             mode=0755
  
- include: deploy.yml 

